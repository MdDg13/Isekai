name: Deploy to Cloudflare Pages
on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'deployment-logs/**'
  workflow_dispatch:
env:
  ENABLE_PAGES_ACTION: ${{ vars.ENABLE_PAGES_ACTION || 'false' }}
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      deployments: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      
      - name: Install dependencies
        run: npm ci
        continue-on-error: false

      - name: Set build environment variables
        run: |
          echo "NEXT_PUBLIC_BUILD_VERSION=$(jq -r .version package.json)-${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "Build version: $(jq -r .version package.json)-${GITHUB_SHA::7}"
          echo "Build time: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
      
      - name: Build project
        id: build
        env:
          NEXT_PUBLIC_BUILD_VERSION: ${{ env.NEXT_PUBLIC_BUILD_VERSION }}
          NEXT_PUBLIC_BUILD_TIME: ${{ env.NEXT_PUBLIC_BUILD_TIME }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL || secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY || secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          mkdir -p deployment-logs
          echo "Building with NEXT_PUBLIC_BUILD_VERSION=$NEXT_PUBLIC_BUILD_VERSION"
          echo "Building with NEXT_PUBLIC_BUILD_TIME=$NEXT_PUBLIC_BUILD_TIME"
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ] || [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then
            echo "WARNING: Supabase environment variables not set in GitHub repository variables/secrets"
            echo "These must be set for the build to work correctly"
          else
            echo "Supabase URL configured: ${NEXT_PUBLIC_SUPABASE_URL:0:30}..."
            echo "Supabase key configured: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:0:30}..."
          fi
          npm run build 2>&1 | tee deployment-logs/build-$(date +%Y%m%d-%H%M%S).log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "ERROR: Build failed with exit code $BUILD_EXIT_CODE"
            exit $BUILD_EXIT_CODE
          fi
          # Verify out/ directory was created
          if [ ! -d out ] || [ -z "$(ls -A out)" ]; then
            echo "ERROR: Build succeeded but out/ directory is empty or missing"
            echo "Attempting to create out/ directory manually..."
            mkdir -p out
            # Try next export as fallback
            npx next export -o out 2>&1 | tee deployment-logs/export-fallback-$(date +%Y%m%d-%H%M%S).log || true
            if [ ! -d out ] || [ -z "$(ls -A out)" ]; then
              echo "ERROR: Failed to create out/ directory"
              exit 1
            fi
          fi
          echo "Build successful - out/ directory created"
        continue-on-error: false
      
      - name: Inspect export directory
        run: |
          echo "PWD=$(pwd)"
          echo "Listing out/" && ls -la out || true
          echo "Disk usage of out/" && du -sh out || true
      
      - name: List Cloudflare Pages projects (guard)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID || vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Listing Pages projects for account..." | tee deployment-logs/cf-projects-${{ github.sha }}.log
          curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            | jq -r '.result[].name' | tee -a deployment-logs/cf-projects-${{ github.sha }}.log
          if ! grep -q '^isekai$' deployment-logs/cf-projects-${{ github.sha }}.log; then
            echo "ERROR: Expected Pages project 'isekai' not found in account." | tee -a deployment-logs/cf-projects-${{ github.sha }}.log
            exit 1
          fi

      - name: Publish to Cloudflare Pages (wrangler)
        if: env.ENABLE_PAGES_ACTION == 'true'
        id: deploy
        continue-on-error: false
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID || vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Publishing to Cloudflare Pages project 'isekai' (domain: isekai-f2i.pages.dev)..."
          mkdir -p deployment-logs
          
          if [ ! -d out ] || [ -z "$(ls -A out)" ]; then
            echo "ERROR: out/ directory is empty or missing" | tee deployment-logs/wrangler-deploy-${{ github.sha }}.log
            exit 1
          fi
          
          # Use wrangler directly for more reliable publishing
          set +e  # Don't exit on error immediately
          npx wrangler@latest pages deploy out \
            --project-name="isekai" \
            --commit-dirty=true \
            2>&1 | tee deployment-logs/wrangler-deploy-${{ github.sha }}.log
          WRANGLER_EXIT_CODE=${PIPESTATUS[0]}
          set -e  # Re-enable exit on error
          
          if [ $WRANGLER_EXIT_CODE -ne 0 ]; then
            echo "ERROR: Wrangler deploy failed with exit code $WRANGLER_EXIT_CODE" | tee -a deployment-logs/wrangler-deploy-${{ github.sha }}.log
            echo "Full wrangler output:" | tee -a deployment-logs/wrangler-deploy-${{ github.sha }}.log
            cat deployment-logs/wrangler-deploy-${{ github.sha }}.log | tee -a deployment-logs/wrangler-deploy-${{ github.sha }}.log
            exit $WRANGLER_EXIT_CODE
          fi
          
          # Extract deployment URL from wrangler output
          DEPLOY_URL=$(grep -oP 'https://[^\.]+\.pages\.dev' deployment-logs/wrangler-deploy-${{ github.sha }}.log | head -1 || echo "")
          if [ -n "$DEPLOY_URL" ]; then
            echo "deployment_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "Deployment successful: $DEPLOY_URL"
          else
            echo "WARNING: Could not extract deployment URL from wrangler output"
            echo "Wrangler output:" | tee -a deployment-logs/wrangler-deploy-${{ github.sha }}.log
            cat deployment-logs/wrangler-deploy-${{ github.sha }}.log | tee -a deployment-logs/wrangler-deploy-${{ github.sha }}.log
          fi
      
      - name: Fetch latest deployment info
        if: always() && steps.deploy.outcome == 'success'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID || vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Fetching latest deployment for project 'isekai'..."
          curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/isekai/deployments" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            | jq '.result[0] | {id, url, environment, created_on, stage}' \
            > deployment-logs/deployment-info-${{ github.sha }}.json || echo "Failed to fetch deployment info"
        continue-on-error: true
      
      - name: Save workflow logs
        if: always()
        run: |
          mkdir -p deployment-logs
          echo "## Deployment Summary" > deployment-logs/summary-${{ github.sha }}.md
          echo "" >> deployment-logs/summary-${{ github.sha }}.md
          echo "- **Commit**: ${{ github.sha }}" >> deployment-logs/summary-${{ github.sha }}.md
          echo "- **Author**: ${{ github.actor }}" >> deployment-logs/summary-${{ github.sha }}.md
          echo "- **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> deployment-logs/summary-${{ github.sha }}.md
          echo "- **Build Status**: ${{ steps.build.outcome }}" >> deployment-logs/summary-${{ github.sha }}.md
          echo "- **Deploy Status**: ${{ steps.deploy.outcome }}" >> deployment-logs/summary-${{ github.sha }}.md
          echo "- **Deployment URL**: ${{ steps.deploy.outputs.deployment_url || 'N/A' }}" >> deployment-logs/summary-${{ github.sha }}.md
          if [ -f deployment-logs/deployment-info-${{ github.sha }}.json ]; then
            echo "- **Deployment Info**: $(cat deployment-logs/deployment-info-${{ github.sha }}.json)" >> deployment-logs/summary-${{ github.sha }}.md
          fi
      
      - name: Commit deployment logs to branch
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add deployment-logs/ || true
          if ! git diff --staged --quiet; then
            git commit -m "ci: save deployment logs for ${{ github.sha }} [skip ci]"
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            # Push logs to a dedicated branch to avoid triggering Pages deploys
            git push origin HEAD:deployment-logs || echo "Push to deployment-logs branch failed"
          else
            echo "No changes to commit"
          fi
